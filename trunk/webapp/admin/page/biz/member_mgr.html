<div id="biz_member_list_panel">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
        <legend>客户列表</legend>
    </fieldset>

    <blockquote class="layui-elem-quote">
        <div>
            <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe608;</i> 新增</button>
        </div>
    </blockquote>

    <div class="layui-input-inline ">
        <input type="text" lay-verify="required" placeholder="客户名称" autocomplete="off" align="right"
               class="layui-input">
    </div>
    <button class="layui-btn "> 查询</button>

    <div style="margin-top: 10px;">
        <table id="biz_relation_list_grid" class="jqgrid-table"></table>
        <div id="biz_relation_list_grid_pager"></div>
    </div>
</div>

<div id="biz_member_edit_panel" style="display: none;">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
        <legend>新增客户</legend>
    </fieldset>

    <blockquote class="layui-elem-quote">
        <div>
            <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe603;</i> 返回客户列表</button>
        </div>
    </blockquote>
    <!--&lt;!&ndash;<form class="layui-form layui-form-pane" action="javascript:;">&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-form-item">&ndash;&gt;-->
    <!--&lt;!&ndash;<label class="layui-form-label">客户名称</label>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-input-inline">&ndash;&gt;-->
    <!--&lt;!&ndash;<input type="text" lay-verify="required" name="MemberName" autocomplete="off" class="layui-input">&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-form-item">&ndash;&gt;-->
    <!--&lt;!&ndash;<label class="layui-form-label">客户角色</label>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-input-inline">&ndash;&gt;-->
    <!--&lt;!&ndash;<select name="RoleId">&ndash;&gt;-->
    <!--&lt;!&ndash;</select>&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-form-item">&ndash;&gt;-->
    <!--&lt;!&ndash;<label class="layui-form-label">地址</label>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-input-inline">&ndash;&gt;-->
    <!--&lt;!&ndash;<input type="text" name="Address" autocomplete="off" class="layui-input">&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-form-item">&ndash;&gt;-->
    <!--&lt;!&ndash;<label class="layui-form-label">地区</label>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-input-inline">&ndash;&gt;-->
    <!--&lt;!&ndash;<input type="text" name="MemberArea" autocomplete="off" class="layui-input">&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-form-item">&ndash;&gt;-->
    <!--&lt;!&ndash;<label class="layui-form-label">部门</label>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-input-inline">&ndash;&gt;-->
    <!--&lt;!&ndash;<input type="text" name="MemberBU" autocomplete="off" class="layui-input">&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-form-item">&ndash;&gt;-->
    <!--&lt;!&ndash;<label class="layui-form-label">账号</label>&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-input-inline">&ndash;&gt;-->
    <!--&lt;!&ndash;<input type="text" lay-verify="required" name="MemberAccount" autocomplete="off" class="layui-input">&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->

    <!--&lt;!&ndash;<div class="layui-form-item">&ndash;&gt;-->
    <!--&lt;!&ndash;<div class="layui-input-block">&ndash;&gt;-->
    <!--&lt;!&ndash;<button class="layui-btn" lay-submit="" lay-filter="biz_member_edit_confirm" onclick="return false">立即提交</button>&ndash;&gt;-->
    <!--&lt;!&ndash;<button type="reset" class="layui-btn layui-btn-primary">重置</button>&ndash;&gt;-->
    <!--&lt;!&ndash;<button class="layui-btn layui-btn-primary" onclick="return false">返回</button>&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--</form>-->
    <div class="layui-input-inline ">
        <input type="text" lay-verify="required" placeholder="客户名称" autocomplete="off" align="right"
               class="layui-input">
    </div>
    <button class="layui-btn "> 查询</button>

    <div style="margin-top: 10px;margin-bottom: 10px;">
        <table id="biz_member_list_grid" class="jqgrid-table"></table>
        <div id="biz_member_list_grid_pager"></div>
    </div>

</div>

<script type="text/javascript">
    layui.use(['commonUtil', 'form', 'ajaxUtil'], function () {
        var commonUtil = layui.commonUtil;
        var form = layui.form();
        var ajaxUtil = layui.ajaxUtil;

        var urls = {};
        urls.biz_member_query = '/admin/user/query-all';
        urls.biz_member_save = '/admin/user/save';
        urls.biz_member_delete = '/admin/user/delete';
        urls.biz_member_relation = '/admin/user/relation';
        urls.admin_role_query = '/admin/role/role-list';

        urls.biz_relation_query = '/admin/user/relation-list';
        urls.biz_relation_delete = '/admin/user/relation-delete';

        var controls = {};
        controls.biz_member_list_panel = $('#biz_member_list_panel');
        controls.biz_member_edit_panel = $('#biz_member_edit_panel');

        var M = {};
        M.MODIFY_STATUS = false;
        M.DATA = null;


        function init() {
            bindEvent();
            loadMemberData();
            loadRelationData();
//            initRoleSelect();
        }

        function bindEvent() {
            //自定义验证规则
            form.verify({
                price: [/^(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*))$/, '请输入小数']
            });

            // 监听提交
            form.on('submit(biz_member_edit_confirm)', function (data) {
                var args = data.field;

                if (M.MODIFY_STATUS) {
                    args.id = M.DATA.Id;
                }

                ajaxUtil.doAjaxPost(urls.biz_member_save, args).done(function (ret) {
                    commonUtil.toast(ret.msg);

                    if (ret.status == 0) {
                        controls.biz_member_edit_panel.find('button:eq(-1)').trigger('click');
                        refresh();
                    }
                });

                return false;
            });

            // 点击增加
            controls.biz_member_list_panel.find('button:eq(0)').bind('click', function () {
                showEditPanel();
            });

            //搜索
            controls.biz_member_list_panel.find('button:eq(1)').bind('click', function () {
                var key = controls.biz_member_list_panel.find('input[type=text]:eq(0)');
                var args = {};
                args.keyword = key.val();
                refreshRelation(args);
            });

            // 删除
            $("#biz_relation_list_grid").on({
                'click': function () {
                    var data = JSON.parse(decodeURIComponent($(this).data('relation')));

                    var confirmLayer = layer.confirm('确定删除？', {
                        btn: ['确定', '取消'] //按钮
                    }, function () {
                        layer.close(confirmLayer);
                        ajaxUtil.doAjaxGet(urls.biz_relation_delete, {'id': data.Id}).done(function (ret) {
                            commonUtil.toast(ret.msg);
                            if (ret.status == 0) {
                                refreshRelation();
                            }
                        });
                    }, function () {
                    });
                }
            }, '.biz-relation-delete');

            // 点击返回
            controls.biz_member_edit_panel.find('button:eq(0)').bind('click', function () {
//                controls.biz_member_edit_panel.find('button:eq(-2)').trigger('click');
                showListPanel();
//                M.MODIFY_STATUS = false;
//                M.DATA = null;
//                controls.biz_member_edit_panel.find('input:eq(5)').removeAttr('disabled');

//                form.render();
            });

            // 查询我的客户
            controls.biz_member_edit_panel.find('button:eq(1)').bind('click', function () {
                var keyword = $.trim(controls.biz_member_edit_panel.find('input[type=text]:eq(0)').val());
                refresh({keyword:keyword});
            });

            // 修改
            $("#biz_member_list_grid").on({
                'click': function () {
                    var data = JSON.parse(decodeURIComponent($(this).data('member')));

                    showEditPanel();
                    controls.biz_member_edit_panel.find('input:eq(0)').val(data.MemberName);

                    controls.biz_member_edit_panel.find('select:eq(0)').val(data.RoleId);

                    controls.biz_member_edit_panel.find('input:eq(2)').val(data.Address);
                    controls.biz_member_edit_panel.find('input:eq(3)').val(data.MemberArea);
                    controls.biz_member_edit_panel.find('input:eq(4)').val(data.MemberBU);
                    controls.biz_member_edit_panel.find('input:eq(5)').val(data.member.MemberAccount);

                    controls.biz_member_edit_panel.find('input:eq(5)').attr('disabled', 'disabled');

                    form.render();

                    M.MODIFY_STATUS = true;
                    M.DATA = data;
                }
            }, '.biz-member-modify');

            // 删除
            $("#biz_member_list_grid").on({
                'click': function () {
                    var data = JSON.parse(decodeURIComponent($(this).data('member')));

                    var confirmLayer = layer.confirm('确定删除？', {
                        btn: ['确定', '取消'] //按钮
                    }, function () {
                        layer.close(confirmLayer);
                        ajaxUtil.doAjaxGet(urls.biz_member_delete, {'id': data.Id}).done(function (ret) {
                            commonUtil.toast(ret.msg);
                            if (ret.status == 0) {
                                refresh();
                            }
                        });
                    }, function () {
                    });
                }
            }, '.biz-member-delete');

            // 设为下级
            $("#biz_member_list_grid").on({
                'click': function () {
                    var data = JSON.parse(decodeURIComponent($(this).data('member')));

                    ajaxUtil.doAjaxGet(urls.biz_member_relation, {'sid': data.Id}).done(function (ret) {
                        commonUtil.toast(ret.msg);
                        if (ret.status == 0) {
                            refreshRelation();
                        }
                    });

                }
            }, '.biz-member-relation');
        }

        function initRoleSelect() {
            ajaxUtil.doAjaxGet(urls.admin_role_query, null).done(function (ret) {
                if (ret.status == 0) {
                    var selector = controls.biz_member_edit_panel.find('select:eq(0)');

                    selector.empty();
                    layui.each(ret.data, function (i, o) {
                        selector.append('<option value="' + o.Id + '">' + o.RoleName + '</option>');
                    });

                    form.render();
                }
            });
        }

        function showEditPanel() {
            controls.biz_member_edit_panel.show();
            controls.biz_member_list_panel.hide();
        }

        function showListPanel() {
            controls.biz_member_edit_panel.hide();
            controls.biz_member_list_panel.show();
        }

        function refreshRelation(data) {
            var page = $("#biz_relation_list_grid").getGridParam('page'); // current page
            var rows = $("#biz_relation_list_grid").getGridParam('rows'); // rows
            $("#biz_relation_list_grid").jqGrid('setGridParam', {
                page: page,
                rows: rows,
                postData: data
            }).trigger("reloadGrid");
        }

        function refresh(data) {
            var page = $("#biz_member_list_grid").getGridParam('page'); // current page
            var rows = $("#biz_member_list_grid").getGridParam('rows'); // rows
            $("#biz_member_list_grid").jqGrid('setGridParam', {
                page: page,
                rows: rows,
                postData: data
            }).trigger("reloadGrid")
        }

        function loadMemberData() {
            //app人员表
            $("#biz_member_list_grid").jqGrid({
                colModel: [
                    {label: '客户名称', name: 'MemberName', align: 'center'},
                    {
                        label: '客户角色',
                        name: 'RoleId',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.role.RoleName;
                        }
                    },
                    {label: '地址', name: 'Address', align: 'center'},
                    {label: '地区', name: 'MemberArea', align: 'center'},
                    {label: '部门', name: 'MemberBU', align: 'center'},
                    {
                        label: '主账号',
                        name: 'MemberAccount',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.member.MemberAccount;
                        }
                    },
                    {label: '总积分', name: 'Points', align: 'center'},
                    {label: '总资产', name: 'Asset', align: 'center'},
                    {
                        label: '创建时间',
                        name: 'CreateTime',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.getTimeString(cellValue);
                        }
                    },
                    {
                        label: '操作',
                        align: 'center',
                        width: '210',
                        formatter: function (cellValue, options, rowObject) {
                            var _dom =
//                              '<span data-member="'+encodeURIComponent(JSON.stringify(rowObject))+'" href="javascript:;" class="my-grid-a-span biz-member-relation">设为下级</span>/<span data-member="'+encodeURIComponent(JSON.stringify(rowObject))+'" href="javascript:;" class="my-grid-a-span biz-member-modify">修改</span>/<span data-member="'+encodeURIComponent(JSON.stringify(rowObject))+'" href="javascript:;" class="my-grid-a-span biz-member-delete">删除</span>';
                                '<span data-member="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-member-relation">设为我的客户</span>';

                            return _dom;
                        }
                    }
                ],
                datatype: 'json',
                url: urls.biz_member_query,
                rowNum: 10,
                rowList: [10, 20, 30],
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                height: true,
                fitColumns: true,
                width: true,
                autowidth: true,
                shrinkToFit: true,
                ajaxGridOptions: {
                    dataFilter: function (ret) {
                        var retObj = JSON.parse(ret);
                        if (retObj.status == 0) {
                            return JSON.stringify(retObj.data);
                        } else {
                            commonUtil.toast(retObj.msg);
                        }
                    }
                },
                pager: "#biz_member_list_grid_pager"
            });

            // 初始化宽宽，用于自适应宽度
            $("#biz_member_list_grid").setGridWidth($("#admin-tab-container").width() - 10, true);
        }

        function loadRelationData() {
            //app人员表
            $("#biz_relation_list_grid").jqGrid({
                colModel: [
                    {
                        label: '商家名称',
                        name: 'RelationName',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.shop.MemberName;
                        }
                    },
                    {
                        label: '地址',
                        name: 'Address',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.filter(rowObject.shop.Address);
                        }
                    },
                    {
                        label: '地区',
                        name: 'RelationArea',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.filter(rowObject.shop.MemberArea);
                        }
                    },
                    {
                        label: '部门',
                        name: 'RelationBU',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.filter(rowObject.shop.MemberBU);
                        }
                    },
                    {
                        label: '总积分',
                        name: 'Points',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.shop.Points;
                        }
                    },
                    {
                        label: '总资产',
                        name: 'Asset',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.shop.Asset;
                        }
                    },
                    {
                        label: '操作', align: 'center', formatter: function (cellValue, options, rowObject) {
                        var _dom =
                            '<span data-relation="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-relation-delete">删除</span>';

                        return _dom;
                    }
                    }
                ],
                datatype: 'json',
                url: urls.biz_relation_query,
                rowNum: 10,
                rowList: [10, 20, 30],
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                height: true,
                fitColumns: true,
                width: true,
                autowidth: true,
                shrinkToFit: true,
                ajaxGridOptions: {
                    dataFilter: function (ret) {
                        var retObj = JSON.parse(ret);
                        if (retObj.status == 0) {
                            return JSON.stringify(retObj.data);
                        } else {
                            commonUtil.toast(retObj.msg);
                        }
                    }
                },
                pager: "#biz_relation_list_grid_pager"
            });

            // 初始化宽宽，用于自适应宽度
            $("#biz_relation_list_grid").setGridWidth($("#admin-tab-container").width() - 10, true);
        }


        (function () {
            init();
        })();
    });
</script>