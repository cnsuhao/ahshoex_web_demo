<div id="biz_promotion_list_panel">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
        <legend>活动列表</legend>
    </fieldset>

    <blockquote class="layui-elem-quote">
        <div>
            <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe608;</i> 新增</button>
        </div>
    </blockquote>

    <div style="margin-top: 10px;">
        <table id="biz_promotion_list_grid" class="jqgrid-table"></table>
        <div id="biz_promotion_list_grid_pager"></div>
    </div>
</div>

<div id="biz_promotion_edit_panel" style="display: none;">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
        <legend>新增/修改活动</legend>
    </fieldset>
    <form class="layui-form layui-form-pane" action="javascript:;">
        <div class="layui-form-item">
            <label class="layui-form-label">活动标题</label>
            <div class="layui-input-inline">
                <input type="text" lay-verify="required" name="PromotionTitle" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item " pane="">
            <label class="layui-form-label">活动类型</label>
            <div class="layui-input-block">
                <input lay-filter="biz_promotion_type_radio" type="radio" name="PromotionType" value="1" title="折扣"
                       checked="">
                <input lay-filter="biz_promotion_type_radio" type="radio" name="PromotionType" value="2" title="满减">
                <input lay-filter="biz_promotion_type_radio" type="radio" name="PromotionType" value="3" title="搭赠">
            </div>
        </div>
        <div style="position:relative;top: -15px;border-right: 1px solid #e6e6e6;border-left: 1px solid #e6e6e6;border-bottom: 1px solid #e6e6e6;">
            <div style="padding: 5px;">
                <div class="promotion-gift">
                    <label class="">请输入折扣(0.1~0.99)</label>
                    <div class="layui-input-inline">
                        <input type="text" lay-verify="required" name="PromotionName" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>

                <div style="display: none;" class="promotion-gift">
                    <label class="">满</label>
                    <div class="layui-input-inline">
                        <input type="text" lay-verify="required" name="PromotionName" autocomplete="off"
                               class="layui-input">
                    </div>
                    <span>减</span>
                    <div class="layui-input-inline">
                        <input type="text" lay-verify="required" name="PromotionName" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>

                <div style="display: none;padding: 5px;" class="promotion-gift">
                    <div style="margin-bottom: 5px;">
                        <button class="layui-btn layui-btn-mini layui-btn-normal">洽洽 瓜子 108g<i style="margin-left: 10px;" class="layui-icon">&#xe640;</i></button>
                        <button class="layui-btn layui-btn-mini layui-btn-normal">洽洽 瓜子 108g<i style="margin-left: 10px;" class="layui-icon">&#xe640;</i></button>
                    </div>

                    <div>
                        <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe608;</i>点击选择搭赠商品</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">选择参与厂家</label>

            <div style="border-right: 1px solid #e6e6e6;border-left: 1px solid #e6e6e6;border-bottom: 1px solid #e6e6e6;">
                <div style="padding: 5px;">
                    <div style="margin-bottom: 5px;">
                        <button class="layui-btn layui-btn-mini layui-btn-normal">洽洽 瓜子 108g<i style="margin-left: 10px;" class="layui-icon">&#xe640;</i></button>
                        <button class="layui-btn layui-btn-mini layui-btn-normal">洽洽 瓜子 108g<i style="margin-left: 10px;" class="layui-icon">&#xe640;</i></button>
                    </div>

                    <div>
                        <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe608;</i>点击选择搭赠商品</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">受益角色</label>
            <div class="layui-input-block" style="height:36px;border-right: 1px solid #e6e6e6;border-top: 1px solid #e6e6e6;border-bottom: 1px solid #e6e6e6;">
                <input type="checkbox" name="TargetRole[0]" title="经销商" checked="">
                <input type="checkbox" name="TargetRole[1]" title="分销商" checked="">
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">选择参加活动商品</label>

            <div style="padding:5px;">
                <div style="margin-bottom: 5px;">
                    <button class="layui-btn layui-btn-mini layui-btn-normal">洽洽 瓜子 108g<i style="margin-left: 10px;" class="layui-icon">&#xe640;</i></button>
                    <button class="layui-btn layui-btn-mini layui-btn-normal">洽洽 瓜子 108g<i style="margin-left: 10px;" class="layui-icon">&#xe640;</i></button>
                </div>

                <div>
                    <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe608;</i>点击选择搭赠商品</button>
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">有效期</label>
            <div class="layui-input-inline">
                <input lay-verify="required" class="layui-input" placeholder="开始日" id="promotion_start_time">
            </div>
            <div class="layui-input-inline">
                <input lay-verify="required" class="layui-input" placeholder="截止日" id="promotion_end_time">
            </div>
        </div>



        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="biz_promotion_edit_confirm" onclick="return false">
                    立即提交
                </button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                <button class="layui-btn layui-btn-primary" onclick="return false">返回</button>
            </div>
        </div>
    </form>
</div>

<script type="text/javascript">
    layui.use(['commonUtil', 'form', 'ajaxUtil', 'laydate'], function () {
        var commonUtil = layui.commonUtil;
        var form = layui.form();
        var ajaxUtil = layui.ajaxUtil;
        var laydate = layui.laydate;

        var urls = {};
        urls.biz_promotion_query = '/admin/user/query-all';
        urls.biz_promotion_save = '/admin/user/save';
        urls.biz_promotion_delete = '/admin/user/delete';
        urls.biz_promotion_relation = '/admin/user/relation';
        urls.admin_role_query = '/admin/role/role-list';

        var controls = {};
        controls.biz_promotion_list_panel = $('#biz_promotion_list_panel');
        controls.biz_promotion_edit_panel = $('#biz_promotion_edit_panel');

        var M = {};
        M.MODIFY_STATUS = false;
        M.DATA = null;

        var start = {
            min: laydate.now(),
            max: '2099-06-16 23:59:59',
            format: 'YYYY-MM-DD hh:mm:ss',
            istime: true,
            istoday: true,
            choose: function (date) {
                end.min = date;         //开始日选好后，重置结束日的最小日期
                end.start = date;       //将结束日的初始值设定为开始日
            }
        };

        var end = {
            min: laydate.now(),
            max: '2099-06-16 23:59:59',
            format: 'YYYY-MM-DD hh:mm:ss',
            istoday: true,
            istime:true,
            choose: function (date) {
                start.max = date;      //结束日选好后，重置开始日的最大日期
            }
        };

        function init() {
            bindEvent();
            loadPromotionData();
            loadPromotionGoodsData();
            loadPromotionShopData();
            form.render();
        }

        function bindEvent() {
            //自定义验证规则
            form.verify({
                price: [/^(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*))$/, '请输入小数']

            });

            // 监听活动类型切换
            form.on('radio(biz_promotion_type_radio)', function (data) {
                $('.promotion-gift').hide();
                console.log((parseInt(data.value) - 1));
                $('.promotion-gift:eq(' + (parseInt(data.value) - 1) + ')').show();
                return false;
            });

            $('#promotion_start_time').bind('click', function () {
                start.elem = this;
                laydate(start);
            });

            $('#promotion_end_time').bind('click', function () {
                end.elem = this;
                laydate(end);
            });

            // 监听提交
            form.on('submit(biz_promotion_edit_confirm)', function (data) {
                var args = data.field;

                if (M.MODIFY_STATUS) {
                    args.id = M.DATA.Id;
                }

                ajaxUtil.doAjaxPost(urls.biz_promotion_save, args).done(function (ret) {
                    commonUtil.toast(ret.msg);

                    if (ret.status == 0) {
                        controls.biz_promotion_edit_panel.find('button:eq(-1)').trigger('click');
                        refresh();
                    }
                });

                return false;
            });

            // 点击增加
            controls.biz_promotion_list_panel.find('button:eq(0)').bind('click', function () {
                showEditPanel();
            });

            // 点击返回
            controls.biz_promotion_edit_panel.find('button:eq(-1)').bind('click', function () {
                controls.biz_promotion_edit_panel.find('button:eq(-2)').trigger('click');
                showListPanel();
                M.MODIFY_STATUS = false;
                M.DATA = null;
                controls.biz_promotion_edit_panel.find('input:eq(5)').removeAttr('disabled');

                form.render();
            });

            // 修改
            $("#biz_promotion_list_grid").on({
                'click': function () {
                    var data = JSON.parse(decodeURIComponent($(this).data('promotion')));

                    showEditPanel();
                    controls.biz_promotion_edit_panel.find('input:eq(0)').val(data.PromotionName);

                    controls.biz_promotion_edit_panel.find('select:eq(0)').val(data.RoleId);

                    controls.biz_promotion_edit_panel.find('input:eq(2)').val(data.Address);
                    controls.biz_promotion_edit_panel.find('input:eq(3)').val(data.PromotionArea);
                    controls.biz_promotion_edit_panel.find('input:eq(4)').val(data.PromotionBU);
                    controls.biz_promotion_edit_panel.find('input:eq(5)').val(data.promotion.PromotionAccount);

                    controls.biz_promotion_edit_panel.find('input:eq(5)').attr('disabled', 'disabled');



                    M.MODIFY_STATUS = true;
                    M.DATA = data;
                }
            }, '.biz-promotion-modify');


            // 删除
            $("#biz_promotion_list_grid").on({
                'click': function () {
                    var data = JSON.parse(decodeURIComponent($(this).data('promotion')));

                    var confirmLayer = layer.confirm('确定删除？', {
                        btn: ['确定', '取消'] //按钮
                    }, function () {
                        layer.close(confirmLayer);
                        ajaxUtil.doAjaxGet(urls.biz_promotion_delete, {'id': data.Id}).done(function (ret) {
                            commonUtil.toast(ret.msg);
                            if (ret.status == 0) {
                                refresh();
                            }
                        });
                    }, function () {
                    });
                }
            }, '.biz-promotion-delete');

            // 设为下级
            $("#biz_promotion_list_grid").on({
                'click': function () {
                    var data = JSON.parse(decodeURIComponent($(this).data('promotion')));

                    ajaxUtil.doAjaxGet(urls.biz_promotion_relation, {'sid': data.Id}).done(function (ret) {
                        commonUtil.toast(ret.msg);
                    });

                }
            }, '.biz-promotion-relation');
        }

        function showEditPanel() {
            controls.biz_promotion_edit_panel.show();
            controls.biz_promotion_list_panel.hide();
        }

        function showListPanel() {
            controls.biz_promotion_edit_panel.hide();
            controls.biz_promotion_list_panel.show();
        }

        function refresh() {
            var page = $("#biz_promotion_list_grid").getGridParam('page'); // current page
            var rows = $("#biz_promotion_list_grid").getGridParam('rows'); // rows
            $("#biz_promotion_list_grid").jqGrid('setGridParam', {
                page: page,
                rows: rows
            }).trigger("reloadGrid")
        }

        function loadPromotionData() {
            //app人员表
            $("#biz_promotion_list_grid").jqGrid({
                colModel: [
                    {label: '商家名称', name: 'MemberName', align: 'center'},
                    {
                        label: '商家角色',
                        name: 'RoleId',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.role.RoleName;
                        }
                    },
                    {label: '地址', name: 'Address', align: 'center'},
                    {label: '地区', name: 'MemberArea', align: 'center'},
                    {label: '部门', name: 'MemberBU', align: 'center'},
                    {
                        label: '主账号',
                        name: 'MemberAccount',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.member.MemberAccount;
                        }
                    },
                    {label: '总积分', name: 'Points', align: 'center'},
                    {label: '总资产', name: 'Asset', align: 'center'},
                    {
                        label: '创建时间',
                        name: 'CreateTime',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.getTimeString(cellValue);
                        }
                    },
                    {
                        label: '操作',
                        align: 'center',
                        width: '210',
                        formatter: function (cellValue, options, rowObject) {
                            var _dom =
                                '<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-relation">设为下级</span>/<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-modify">修改</span>/<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-delete">删除</span>';

                            return _dom;
                        }
                    }
                ],
                datatype: 'json',
                url: urls.biz_promotion_query,
                rowNum: 10,
                rowList: [10, 20, 30],
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                height: true,
                fitColumns: true,
                width: true,
                autowidth: true,
                shrinkToFit: true,
                ajaxGridOptions: {
                    dataFilter: function (ret) {
                        var retObj = JSON.parse(ret);
                        if (retObj.status == 0) {
                            return JSON.stringify(retObj.data);
                        } else {
                            commonUtil.toast(retObj.msg);
                        }
                    }
                },
                pager: "#biz_promotion_list_grid_pager"
            });

            // 初始化宽宽，用于自适应宽度
            $("#biz_promotion_list_grid").setGridWidth($("#admin-tab-container").width() - 10, true);
        }
        function loadPromotionShopData() {
            //app人员表
            $("#biz_promotion_shop_list_grid").jqGrid({
                colModel: [
                    {label: '商家名称', name: 'MemberName', align: 'center'},
                    {
                        label: '商家角色',
                        name: 'RoleId',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.role.RoleName;
                        }
                    },
                    {label: '地址', name: 'Address', align: 'center'},
                    {label: '地区', name: 'MemberArea', align: 'center'},
                    {label: '部门', name: 'MemberBU', align: 'center'},
                    {
                        label: '主账号',
                        name: 'MemberAccount',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.member.MemberAccount;
                        }
                    },
                    {label: '总积分', name: 'Points', align: 'center'},
                    {label: '总资产', name: 'Asset', align: 'center'},
                    {
                        label: '创建时间',
                        name: 'CreateTime',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.getTimeString(cellValue);
                        }
                    },
                    {
                        label: '操作',
                        align: 'center',
                        width: '210',
                        formatter: function (cellValue, options, rowObject) {
                            var _dom =
                                '<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-relation">设为下级</span>/<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-modify">修改</span>/<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-delete">删除</span>';

                            return _dom;
                        }
                    }
                ],
                datatype: 'json',
                url: urls.biz_promotion_query,
                rowNum: 10,
                rowList: [10, 20, 30],
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                height: true,
                fitColumns: true,
                width: true,
                autowidth: true,
                shrinkToFit: true,
                ajaxGridOptions: {
                    dataFilter: function (ret) {
                        var retObj = JSON.parse(ret);
                        if (retObj.status == 0) {
                            return JSON.stringify(retObj.data);
                        } else {
                            commonUtil.toast(retObj.msg);
                        }
                    }
                },
                pager: "#biz_promotion_shop_list_grid_pager"
            });

            // 初始化宽宽，用于自适应宽度
            $("#biz_promotion_shop_list_grid").setGridWidth($("#admin-tab-container").width() - 10, true);
        }
        function loadPromotionGoodsData() {
            //app人员表
            $("#biz_promotion_goods_list_grid").jqGrid({
                colModel: [
                    {label: '商家名称', name: 'MemberName', align: 'center'},
                    {
                        label: '商家角色',
                        name: 'RoleId',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.role.RoleName;
                        }
                    },
                    {label: '地址', name: 'Address', align: 'center'},
                    {label: '地区', name: 'MemberArea', align: 'center'},
                    {label: '部门', name: 'MemberBU', align: 'center'},
                    {
                        label: '主账号',
                        name: 'MemberAccount',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.member.MemberAccount;
                        }
                    },
                    {label: '总积分', name: 'Points', align: 'center'},
                    {label: '总资产', name: 'Asset', align: 'center'},
                    {
                        label: '创建时间',
                        name: 'CreateTime',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.getTimeString(cellValue);
                        }
                    },
                    {
                        label: '操作',
                        align: 'center',
                        width: '210',
                        formatter: function (cellValue, options, rowObject) {
                            var _dom =
                                '<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-relation">设为下级</span>/<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-modify">修改</span>/<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-delete">删除</span>';

                            return _dom;
                        }
                    }
                ],
                datatype: 'json',
                url: urls.biz_promotion_query,
                rowNum: 10,
                rowList: [10, 20, 30],
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                height: true,
                fitColumns: true,
                width: true,
                autowidth: true,
                shrinkToFit: true,
                ajaxGridOptions: {
                    dataFilter: function (ret) {
                        var retObj = JSON.parse(ret);
                        if (retObj.status == 0) {
                            return JSON.stringify(retObj.data);
                        } else {
                            commonUtil.toast(retObj.msg);
                        }
                    }
                },
                pager: "#biz_promotion_goods_list_grid_pager"
            });

            // 初始化宽宽，用于自适应宽度
            $("#biz_promotion_goods_list_grid").setGridWidth($("#admin-tab-container").width() - 10, true);
        }


        (function () {
            init();
        })();
    });
</script>